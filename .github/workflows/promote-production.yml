name: Promote to Production

on:
  workflow_dispatch:
    inputs:
      rc_tag:
        description: 'RC tag to promote (e.g., v1.2.3-rc.1)'
        required: true

env:
  REGISTRY: ghcr.io

jobs:
  retag-and-promote:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Set lowercase repository name
        run: |
          echo "IMAGE_NAME=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Extract version from RC tag
        run: |
          # v1.2.3-rc.1 â†’ v1.2.3
          RELEASE_TAG=$(echo "${{ github.event.inputs.rc_tag }}" | sed 's/-rc\..*//')
          echo "RELEASE_TAG=${RELEASE_TAG}" >> $GITHUB_ENV

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Pull RC image
        run: |
          RC_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.rc_tag }}"
          echo "Pulling: $RC_IMAGE"
          docker pull $RC_IMAGE

      - name: Re-tag for production
        run: |
          RC_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.rc_tag }}"
          PROD_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.RELEASE_TAG }}"
          STABLE_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:stable"
          
          echo "Re-tagging for production:"
          echo "- $PROD_IMAGE"
          echo "- $STABLE_IMAGE"
          
          docker tag $RC_IMAGE $PROD_IMAGE
          docker tag $RC_IMAGE $STABLE_IMAGE
          
          docker push $PROD_IMAGE
          docker push $STABLE_IMAGE
          
          echo "PROD_IMAGE=${PROD_IMAGE}" >> $GITHUB_ENV

      - name: Update production overlay
        run: |
          echo "Updating production manifest..."
          
          cat > k8s/overlays/production/patches/image-patch.yaml << YAML
apiVersion: apps/v1
kind: Deployment
metadata:
  name: flask-app
spec:
  template:
    spec:
      containers:
      - name: flask-app
        image: ${{ env.PROD_IMAGE }}
YAML

          if ! grep -q "image-patch.yaml" k8s/overlays/production/kustomization.yaml; then
            echo "  - path: patches/image-patch.yaml" >> k8s/overlays/production/kustomization.yaml
          fi

      - name: Create release
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add k8s/overlays/production/
          git commit -m "release: deploy ${{ env.RELEASE_TAG }} to production

Promoted from: ${{ github.event.inputs.rc_tag }}
Version: ${{ env.RELEASE_TAG }}
Image: ${{ env.PROD_IMAGE }}

This release has been tested in staging and is ready for production."
          
          git tag -a "${{ env.RELEASE_TAG }}" -m "Release ${{ env.RELEASE_TAG }}"
          git push origin main
          git push origin "${{ env.RELEASE_TAG }}"
          
          echo "Deployed to production as ${{ env.RELEASE_TAG }}"
